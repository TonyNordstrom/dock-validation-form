<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dock Validation – Public Form</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --brand:#0a5bd3; --ok:#1a7f37; --warn:#b54708; --fail:#c01818;
    --bg:#f6f7fb; --text:#1f2328; --muted:#6e7781; --border:#d0d7de;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  header{background:#fff;border-bottom:1px solid var(--border);padding:16px 20px;position:sticky;top:0;z-index:2}
  header h1{margin:0;font-size:18px}
  main{max-width:920px;margin:24px auto;padding:0 16px 48px}
  .card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:16px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-8{grid-column:span 8}
  .col-12{grid-column:span 12}
  @media (max-width:720px){.col-6,.col-4,.col-8{grid-column:span 12}}
  label{font-weight:600;display:block;margin:6px 0}
  input[type=text], input[type=number], select, textarea{
    width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff
  }
  textarea{min-height:70px}
  .muted{color:var(--muted);font-size:13px}
  .help{font-size:13px;color:var(--muted);margin-top:4px}
  .section{display:none}
  .section.active{display:block}
  .q{border:1px dashed var(--border);border-radius:10px;padding:14px;margin:10px 0;background:#fbfcff}
  .q h4{margin:.2rem 0 .5rem 0;font-size:15px}
  .choices{display:flex;gap:14px;align-items:center;margin-top:6px}
  .chip{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:20px}
  .note{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;border-radius:8px;padding:10px;margin-top:8px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .fail{color:var(--fail)}
  .hidden{display:none !important}
  .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  button{
    appearance:none;border:1px solid var(--border);background:#fff;border-radius:8px;padding:10px 14px;
    cursor:pointer;font-weight:600
  }
  button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  canvas{width:100%;max-width:520px;height:160px;border:1px solid var(--border);border-radius:8px;background:#fff}
  .hr{height:1px;background:var(--border);margin:18px 0}
  .stepper{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  .step{padding:4px 10px;border-radius:20px;border:1px solid var(--border);background:#fff;color:var(--muted);font-size:12px}
  .step.on{background:var(--brand);border-color:var(--brand);color:#fff}
  .success{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;border-radius:8px;padding:14px}
  .err{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;border-radius:8px;padding:10px;margin-top:8px}
  .required::after{content:" *";color:var(--fail)}
</style>
</head>
<body>
<header><h1>Dock Validation – Public Submission</h1></header>
<main>
  <!-- Stepper -->
  <div class="stepper" id="stepper"></div>

  <!-- BASIC INFORMATION -->
  <section class="card section active" id="sec-basic">
    <h2>Basic Information</h2>
    <div class="row">
      <div class="col-6">
        <label class="required" for="empName">Employee Name</label>
        <input id="empName" autocomplete="name" required />
      </div>
      <div class="col-6">
        <label class="required" for="empNo">Employee Number</label>
        <input id="empNo" inputmode="numeric" />
      </div>
      <div class="col-4">
        <label class="required" for="dockDoor">Dock Door Number</label>
        <input id="dockDoor" />
      </div>
      <div class="col-4">
        <label class="required" for="vehicleNo">Vehicle Number</label>
        <input id="vehicleNo" />
      </div>
      <div class="col-4">
        <label class="required">Shift</label>
        <div class="choices">
          <label><input type="radio" name="shift" value="1st Shift"> 1st Shift</label>
          <label><input type="radio" name="shift" value="2nd Shift"> 2nd Shift</label>
        </div>
      </div>
      <div class="col-12">
        <label class="required" for="checklistType">Dock Validation Type</label>
        <select id="checklistType">
          <option value="">— Select —</option>
          <option>Long Box Trailer Dock Validation Checklist</option>
          <option>Half Set Trailer Dock Validation Checklist</option>
          <option>Box Truck Dock Validation Checklist</option>
        </select>
        <div class="help">This controls which question path appears next.</div>
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="toVisual">Start Visual Check</button>
    </div>
  </section>

  <!-- VISUAL CHECK -->
  <section class="card section" id="sec-visual">
    <h2>Visual Check</h2>
    <div id="vc-container"></div>
    <div class="actions">
      <button id="vc-prev">Back</button>
      <button class="primary" id="vc-next">Next section</button>
    </div>
  </section>

  <!-- DEDICATED CARRIER VALIDATION (Long/Half Set) -->
  <section class="card section" id="sec-dcv">
    <h2>Dedicated Carrier Validation</h2>
    <div id="dcv-container"></div>
    <div class="actions">
      <button id="dcv-prev">Back</button>
      <button class="primary" id="dcv-next">Next section</button>
    </div>
  </section>

  <!-- CARRIER DRIVER VALIDATION (Box Truck) -->
  <section class="card section" id="sec-cdv">
    <h2>Carrier Driver Validation</h2>
    <div id="cdv-container"></div>
    <div class="actions">
      <button id="cdv-prev">Back</button>
      <button class="primary" id="cdv-next">Next section</button>
    </div>
  </section>

  <!-- DRIVER / OUTCOME -->
  <section class="card section" id="sec-outcome">
    <h2>Driver / Outcome</h2>
    <div class="row">
      <div class="col-6" id="driverNameWrap">
        <label class="required" for="driverName" id="driverLabel">JB Hunt / Ryder Driver Name</label>
        <input id="driverName" />
      </div>
      <div class="col-6 hidden" id="carrierNameWrap">
        <label class="required" for="carrierName">Carrier Name</label>
        <input id="carrierName" />
      </div>
      <div class="col-12">
        <label class="required">Outcome</label>
        <div class="choices">
          <label><input type="radio" name="outcome" value="Pass (✓)"> Pass (✓)</label>
          <label><input type="radio" name="outcome" value="Fail (X)"> Fail (X)</label>
        </div>
        <div id="failMsg" class="note hidden"><strong>STOP</strong> and notify a Manager immediately.</div>
      </div>
      <div class="col-12">
        <div class="hr"></div>
        <h3>Signature</h3>
        <p class="muted">Use your finger/mouse to sign in the box.</p>
        <canvas id="sigPad" aria-label="Signature pad"></canvas>
        <div class="actions">
          <button type="button" id="sigClear">Clear signature</button>
        </div>
      </div>
      <div class="col-12">
        <h3>Photo</h3>
        <input id="photo" type="file" accept="image/*" capture="environment" />
        <div class="help">You can take a picture or upload an image.</div>
      </div>
      <div class="col-12">
        <label for="notes">Additional Notes (optional)</label>
        <textarea id="notes" placeholder="Optional"></textarea>
      </div>
    </div>
    <div class="actions">
      <button id="outcome-prev">Back</button>
      <button class="primary" id="submitBtn">Submit</button>
    </div>
  </section>

  <!-- SUCCESS -->
  <section class="card section" id="sec-success">
    <h2>Submission received</h2>
    <div class="success">
      Your dock validation was captured locally. A **receipt JSON** was downloaded to your device.
      If you’d like to post this to a server later, set <code>CONFIG.postUrl</code> in the code.
    </div>
    <div class="actions">
      <button id="submitAnother">Submit another response</button>
    </div>
  </section>
</main>

<!-- Signature pad library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script>
/* =========================================================================================
   CONFIG
   -----------------------------------------------------------------------------------------
   By default, submissions are saved as a downloadable JSON file (no server needed).
   To POST to a backend, set CONFIG.postUrl to your HTTPS endpoint.
   You can handle uploads as Base64 fields (signature/photo) in your server.
   =======================================================================================*/
const CONFIG = {
  postUrl: "{"nodeId":"manual","nodeData":{"id":"manual","nodeInputs":{"parameterGroups":{"default":{"id":"default","description":"","parameters":[{"id":"DA351A43-71E3-4192-B8C6-20A8D5E6AD6A","editor":"combobox","editorOptions":{"options":[{"displayName":"Any user in my tenant","value":"Tenant"},{"displayName":"Specific users in my tenant","value":"User"},{"displayName":"Anyone","value":"All"}]},"info":{"isDynamic":false},"hideInUI":false,"label":"Who can trigger the flow?","parameterKey":"inputs.$.triggerAuthenticationType","parameterName":"triggerAuthenticationType","preservedValue":"All","required":true,"schema":{"type":"string","title":"Who can trigger the flow?","default":"Tenant","x-ms-editor":"combobox","x-ms-editor-options":{"options":[{"displayName":"Any user in my tenant","value":"Tenant"},{"displayName":"Specific users in my tenant","value":"User"},{"displayName":"Anyone","value":"All"}]}},"showErrors":false,"showTokens":true,"suppressCasting":true,"type":"string","value":[{"id":"72F5F44D-7C6F-41D3-93E3-A8B65918B510","type":"literal","value":"All","valueType":"string"}],"visibility":""},{"id":"F851ACA7-70AA-4674-8F2E-E1162975C985","info":{"dependencies":{"type":"visibility","parameters":[{"name":"triggerAuthenticationType","values":["User"]}]},"isDynamic":false},"hideInUI":false,"label":"Allowed users","parameterKey":"inputs.$.triggerAllowedUsers","parameterName":"triggerAllowedUsers","placeholder":"Email addresses, separated by a semicolon (;)","required":false,"schema":{"type":"string","title":"Allowed users","description":"Email addresses, separated by a semicolon (;)","x-ms-visibility":"important","x-ms-input-dependencies":{"type":"visibility","parameters":[{"name":"triggerAuthenticationType","values":["User"]}]}},"showErrors":false,"showTokens":true,"suppressCasting":true,"type":"string","value":[{"id":"BEFD8C00-CCF5-4118-B6CF-E8F4A838BE08","type":"literal","value":"","valueType":"string"}],"visibility":"important"},{"id":"66859868-24D5-450A-88A0-2D16886FF3A1","editor":"copyable","info":{"isDynamic":false,"serialization":{"skip":true}},"hideInUI":false,"label":"HTTP URL","parameterKey":"inputs.$.callbackUrl","parameterName":"callbackUrl","placeholder":"URL will be generated after save","required":false,"schema":{"type":"string","title":"HTTP URL","description":"URL will be generated after save","x-ms-visibility":"important","x-ms-editor":"copyable","x-ms-serialization":{"skip":true}},"showErrors":false,"showTokens":true,"suppressCasting":true,"type":"string","value":[{"id":"0F489B58-6EBA-4CF6-B4D5-873F3A8A73D8","type":"literal","value":"https://defaultc291be2656fe41058955fec9bd564d.a1.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cf785760560f4833a89518ec0e096132/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=rbjCRqOwUGwe5Rqs8A7vuRC2PXLmBXafYlryaFs0m-o","valueType":"string"}],"visibility":"important"},{"id":"610C9759-04C8-45BB-AE40-15F603A620FB","editor":"schema","info":{"isDynamic":false},"hideInUI":false,"label":"Request Body JSON Schema","parameterKey":"inputs.$.schema","parameterName":"schema","placeholder":"Example:\\n{\\n \"type\": \"object\",\\n \"properties\": {\\n \"address\": {\\n \"type\": \"string\"\\n }\\n },\\n \"required\": [\"address\"]\\n}","preservedValue":{"type":"object","properties":{"meta":{"type":"object","properties":{"timestamp":{"type":"string"},"submissionId":{"type":"string"}}},"basic":{"type":"object","properties":{"employeeName":{"type":"string"},"employeeNumber":{"type":"string"},"dockDoorNumber":{"type":"string"},"vehicleNumber":{"type":"string"},"shift":{"type":"string"},"checklistType":{"type":"string"}}},"driver":{"type":"object","properties":{"driverName":{"type":"string"},"carrierName":{"type":"string"}}},"outcome":{"type":"string"},"notes":{"type":"string"}}},"required":false,"schema":{"type":"object","title":"Request Body JSON Schema","description":"Example:\\n{\\n \"type\": \"object\",\\n \"properties\": {\\n \"address\": {\\n \"type\": \"string\"\\n }\\n },\\n \"required\": [\"address\"]\\n}","x-ms-visibility":"important","x-ms-editor":"schema"},"showErrors":false,"showTokens":true,"suppressCasting":true,"type":"object","value":[{"id":"2D93BB6D-503F-4546-AD23-0996F4A38DD3","type":"literal","value":"{\n \"type\": \"object\",\n \"properties\": {\n \"meta\": {\n \"type\": \"object\",\n \"properties\": {\n \"timestamp\": {\n \"type\": \"string\"\n },\n \"submissionId\": {\n \"type\": \"string\"\n }\n }\n },\n \"basic\": {\n \"type\": \"object\",\n \"properties\": {\n \"employeeName\": {\n \"type\": \"string\"\n },\n \"employeeNumber\": {\n \"type\": \"string\"\n },\n \"dockDoorNumber\": {\n \"type\": \"string\"\n },\n \"vehicleNumber\": {\n \"type\": \"string\"\n },\n \"shift\": {\n \"type\": \"string\"\n },\n \"checklistType\": {\n \"type\": \"string\"\n }\n }\n },\n \"driver\": {\n \"type\": \"object\",\n \"properties\": {\n \"driverName\": {\n \"type\": \"string\"\n },\n \"carrierName\": {\n \"type\": \"string\"\n }\n }\n },\n \"outcome\": {\n \"type\": \"string\"\n },\n \"notes\": {\n \"type\": \"string\"\n }\n }\n}","valueType":"string"}],"visibility":"important"},{"id":"A0F4E3FF-B78F-4F3F-9C2A-1B660C5F3184","editor":"combobox","editorOptions":{"options":[{"displayName":"GET","value":"GET"},{"displayName":"PUT","value":"PUT"},{"displayName":"POST","value":"POST"},{"displayName":"PATCH","value":"PATCH"},{"displayName":"DELETE","value":"DELETE"}]},"info":{"isDynamic":false},"hideInUI":false,"conditionalVisibility":false,"label":"Method","parameterKey":"inputs.$.method","parameterName":"method","required":false,"schema":{"type":"string","title":"Method","x-ms-editor":"combobox","x-ms-editor-options":{"options":[{"displayName":"GET","value":"GET"},{"displayName":"PUT","value":"PUT"},{"displayName":"POST","value":"POST"},{"displayName":"PATCH","value":"PATCH"},{"displayName":"DELETE","value":"DELETE"}]}},"showErrors":false,"showTokens":true,"suppressCasting":true,"type":"string","value":[{"id":"CE2C0024-EF60-48A7-84F9-4623372C4AEC","type":"literal","value":"","valueType":"string"}],"visibility":""},{"id":"29F8B729-715B-46C4-9D5D-32B82DCFFD73","info":{"isDynamic":false},"hideInUI":false,"conditionalVisibility":false,"label":"Relative path","parameterKey":"inputs.$.relativePath","parameterName":"relativePath","required":false,"schema":{"type":"string","title":"Relative path"},"showErrors":false,"showTokens":true,"suppressCasting":true,"type":"string","value":[{"id":"C05313C8-3403-400F-A24A-52928317DDDB","type":"literal","value":"","valueType":"string"}],"visibility":""}],"rawInputs":[{"default":"Tenant","editor":"combobox","editorOptions":{"options":[{"displayName":"Any user in my tenant","value":"Tenant"},{"displayName":"Specific users in my tenant","value":"User"},{"displayName":"Anyone","value":"All"}]},"isNested":true,"key":"inputs.$.triggerAuthenticationType","name":"triggerAuthenticationType","required":true,"schema":{"type":"string","title":"Who can trigger the flow?","default":"Tenant","x-ms-editor":"combobox","x-ms-editor-options":{"options":[{"displayName":"Any user in my tenant","value":"Tenant"},{"displayName":"Specific users in my tenant","value":"User"},{"displayName":"Anyone","value":"All"}]}},"summary":"","suppressCasting":true,"title":"Who can trigger the flow?","type":"string","visibility":"","hideInUI":false,"value":"All"},{"dependencies":{"type":"visibility","parameters":[{"name":"triggerAuthenticationType","values":["User"]}]},"description":"Email addresses, separated by a semicolon (;)","isNested":true,"key":"inputs.$.triggerAllowedUsers","name":"triggerAllowedUsers","required":false,"schema":{"type":"string","title":"Allowed users","description":"Email addresses, separated by a semicolon (;)","x-ms-visibility":"important","x-ms-input-dependencies":{"type":"visibility","parameters":[{"name":"triggerAuthenticationType","values":["User"]}]}},"summary":"","suppressCasting":true,"title":"Allowed users","type":"string","visibility":"important","hideInUI":false},{"description":"URL will be generated after save","editor":"copyable","isNested":true,"key":"inputs.$.callbackUrl","name":"callbackUrl","required":false,"schema":{"type":"string","title":"HTTP URL","description":"URL will be generated after save","x-ms-visibility":"important","x-ms-editor":"copyable","x-ms-serialization":{"skip":true}},"serialization":{"skip":true},"summary":"","suppressCasting":true,"title":"HTTP URL","type":"string","visibility":"important","hideInUI":false},{"description":"Example:\\n{\\n \"type\": \"object\",\\n \"properties\": {\\n \"address\": {\\n \"type\": \"string\"\\n }\\n },\\n \"required\": [\"address\"]\\n}","editor":"schema","isNested":true,"key":"inputs.$.schema","name":"schema","required":false,"schema":{"type":"object","title":"Request Body JSON Schema","description":"Example:\\n{\\n \"type\": \"object\",\\n \"properties\": {\\n \"address\": {\\n \"type\": \"string\"\\n }\\n },\\n \"required\": [\"address\"]\\n}","x-ms-visibility":"important","x-ms-editor":"schema"},"summary":"","suppressCasting":true,"title":"Request Body JSON Schema","type":"object","visibility":"important","hideInUI":false,"value":{"type":"object","properties":{"meta":{"type":"object","properties":{"timestamp":{"type":"string"},"submissionId":{"type":"string"}}},"basic":{"type":"object","properties":{"employeeName":{"type":"string"},"employeeNumber":{"type":"string"},"dockDoorNumber":{"type":"string"},"vehicleNumber":{"type":"string"},"shift":{"type":"string"},"checklistType":{"type":"string"}}},"driver":{"type":"object","properties":{"driverName":{"type":"string"},"carrierName":{"type":"string"}}},"outcome":{"type":"string"},"notes":{"type":"string"}}}},{"editor":"combobox","editorOptions":{"options":[{"displayName":"GET","value":"GET"},{"displayName":"PUT","value":"PUT"},{"displayName":"POST","value":"POST"},{"displayName":"PATCH","value":"PATCH"},{"displayName":"DELETE","value":"DELETE"}]},"isNested":true,"key":"inputs.$.method","name":"method","required":false,"schema":{"type":"string","title":"Method","x-ms-editor":"combobox","x-ms-editor-options":{"options":[{"displayName":"GET","value":"GET"},{"displayName":"PUT","value":"PUT"},{"displayName":"POST","value":"POST"},{"displayName":"PATCH","value":"PATCH"},{"displayName":"DELETE","value":"DELETE"}]}},"summary":"","suppressCasting":true,"title":"Method","type":"string","visibility":"","hideInUI":false},{"isNested":true,"key":"inputs.$.relativePath","name":"relativePath","required":false,"schema":{"type":"string","title":"Relative path"},"summary":"","suppressCasting":true,"title":"Relative path","type":"string","visibility":"","hideInUI":false}]}}},"nodeOutputs":{"outputs":{"outputs.$.body.meta.timestamp":{"key":"outputs.$.body.meta.timestamp","type":"string","isAdvanced":false,"name":"body.meta.timestamp","title":"timestamp","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.meta.submissionId":{"key":"outputs.$.body.meta.submissionId","type":"string","isAdvanced":false,"name":"body.meta.submissionId","title":"submissionId","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.meta":{"key":"outputs.$.body.meta","type":"object","isAdvanced":false,"name":"body.meta","title":"meta","schema":{"type":"object","properties":{"timestamp":{"type":"string"},"submissionId":{"type":"string"}}},"source":"outputs","required":false},"outputs.$.body.basic.employeeName":{"key":"outputs.$.body.basic.employeeName","type":"string","isAdvanced":false,"name":"body.basic.employeeName","title":"employeeName","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.employeeNumber":{"key":"outputs.$.body.basic.employeeNumber","type":"string","isAdvanced":false,"name":"body.basic.employeeNumber","title":"employeeNumber","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.dockDoorNumber":{"key":"outputs.$.body.basic.dockDoorNumber","type":"string","isAdvanced":false,"name":"body.basic.dockDoorNumber","title":"dockDoorNumber","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.vehicleNumber":{"key":"outputs.$.body.basic.vehicleNumber","type":"string","isAdvanced":false,"name":"body.basic.vehicleNumber","title":"vehicleNumber","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.shift":{"key":"outputs.$.body.basic.shift","type":"string","isAdvanced":false,"name":"body.basic.shift","title":"shift","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.checklistType":{"key":"outputs.$.body.basic.checklistType","type":"string","isAdvanced":false,"name":"body.basic.checklistType","title":"checklistType","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic":{"key":"outputs.$.body.basic","type":"object","isAdvanced":false,"name":"body.basic","title":"basic","schema":{"type":"object","properties":{"employeeName":{"type":"string"},"employeeNumber":{"type":"string"},"dockDoorNumber":{"type":"string"},"vehicleNumber":{"type":"string"},"shift":{"type":"string"},"checklistType":{"type":"string"}}},"source":"outputs","required":false},"outputs.$.body.driver.driverName":{"key":"outputs.$.body.driver.driverName","type":"string","isAdvanced":false,"name":"body.driver.driverName","title":"driverName","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.driver.carrierName":{"key":"outputs.$.body.driver.carrierName","type":"string","isAdvanced":false,"name":"body.driver.carrierName","title":"carrierName","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.driver":{"key":"outputs.$.body.driver","type":"object","isAdvanced":false,"name":"body.driver","title":"driver","schema":{"type":"object","properties":{"driverName":{"type":"string"},"carrierName":{"type":"string"}}},"source":"outputs","required":false},"outputs.$.body.outcome":{"key":"outputs.$.body.outcome","type":"string","isAdvanced":false,"name":"body.outcome","title":"outcome","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.notes":{"key":"outputs.$.body.notes","type":"string","isAdvanced":false,"name":"body.notes","title":"notes","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body":{"key":"outputs.$.body","type":"object","isAdvanced":false,"name":"body","title":"Body","schema":{"type":"object","properties":{"meta":{"type":"object","properties":{"timestamp":{"type":"string"},"submissionId":{"type":"string"}}},"basic":{"type":"object","properties":{"employeeName":{"type":"string"},"employeeNumber":{"type":"string"},"dockDoorNumber":{"type":"string"},"vehicleNumber":{"type":"string"},"shift":{"type":"string"},"checklistType":{"type":"string"}}},"driver":{"type":"object","properties":{"driverName":{"type":"string"},"carrierName":{"type":"string"}}},"outcome":{"type":"string"},"notes":{"type":"string"}}},"source":"outputs","required":false},"outputs.$.headers":{"key":"outputs.$.headers","type":"object","isAdvanced":false,"name":"headers","title":"Headers","schema":{"type":"object","title":"Headers"},"source":"outputs","required":false},"outputs.$.relativePathParameters":{"key":"outputs.$.relativePathParameters","type":"object","isAdvanced":false,"name":"relativePathParameters","title":"Headers","schema":{"type":"object","title":"Headers"},"source":"outputs","required":false},"outputs.$.queries":{"key":"outputs.$.queries","type":"object","isAdvanced":false,"name":"queries","title":"Queries","schema":{"type":"object","title":"Queries"},"source":"outputs","required":false}},"originalOutputs":{"outputs.$.body.meta.timestamp":{"key":"outputs.$.body.meta.timestamp","type":"string","isAdvanced":false,"name":"body.meta.timestamp","title":"timestamp","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.meta.submissionId":{"key":"outputs.$.body.meta.submissionId","type":"string","isAdvanced":false,"name":"body.meta.submissionId","title":"submissionId","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.meta":{"key":"outputs.$.body.meta","type":"object","isAdvanced":false,"name":"body.meta","title":"meta","schema":{"type":"object","properties":{"timestamp":{"type":"string"},"submissionId":{"type":"string"}}},"source":"outputs","required":false},"outputs.$.body.basic.employeeName":{"key":"outputs.$.body.basic.employeeName","type":"string","isAdvanced":false,"name":"body.basic.employeeName","title":"employeeName","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.employeeNumber":{"key":"outputs.$.body.basic.employeeNumber","type":"string","isAdvanced":false,"name":"body.basic.employeeNumber","title":"employeeNumber","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.dockDoorNumber":{"key":"outputs.$.body.basic.dockDoorNumber","type":"string","isAdvanced":false,"name":"body.basic.dockDoorNumber","title":"dockDoorNumber","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.vehicleNumber":{"key":"outputs.$.body.basic.vehicleNumber","type":"string","isAdvanced":false,"name":"body.basic.vehicleNumber","title":"vehicleNumber","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.shift":{"key":"outputs.$.body.basic.shift","type":"string","isAdvanced":false,"name":"body.basic.shift","title":"shift","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic.checklistType":{"key":"outputs.$.body.basic.checklistType","type":"string","isAdvanced":false,"name":"body.basic.checklistType","title":"checklistType","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.basic":{"key":"outputs.$.body.basic","type":"object","isAdvanced":false,"name":"body.basic","title":"basic","schema":{"type":"object","properties":{"employeeName":{"type":"string"},"employeeNumber":{"type":"string"},"dockDoorNumber":{"type":"string"},"vehicleNumber":{"type":"string"},"shift":{"type":"string"},"checklistType":{"type":"string"}}},"source":"outputs","required":false},"outputs.$.body.driver.driverName":{"key":"outputs.$.body.driver.driverName","type":"string","isAdvanced":false,"name":"body.driver.driverName","title":"driverName","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.driver.carrierName":{"key":"outputs.$.body.driver.carrierName","type":"string","isAdvanced":false,"name":"body.driver.carrierName","title":"carrierName","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.driver":{"key":"outputs.$.body.driver","type":"object","isAdvanced":false,"name":"body.driver","title":"driver","schema":{"type":"object","properties":{"driverName":{"type":"string"},"carrierName":{"type":"string"}}},"source":"outputs","required":false},"outputs.$.body.outcome":{"key":"outputs.$.body.outcome","type":"string","isAdvanced":false,"name":"body.outcome","title":"outcome","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body.notes":{"key":"outputs.$.body.notes","type":"string","isAdvanced":false,"name":"body.notes","title":"notes","schema":{"type":"string"},"source":"outputs","required":false},"outputs.$.body":{"key":"outputs.$.body","type":"object","isAdvanced":false,"name":"body","title":"Body","schema":{"type":"object","properties":{"meta":{"type":"object","properties":{"timestamp":{"type":"string"},"submissionId":{"type":"string"}}},"basic":{"type":"object","properties":{"employeeName":{"type":"string"},"employeeNumber":{"type":"string"},"dockDoorNumber":{"type":"string"},"vehicleNumber":{"type":"string"},"shift":{"type":"string"},"checklistType":{"type":"string"}}},"driver":{"type":"object","properties":{"driverName":{"type":"string"},"carrierName":{"type":"string"}}},"outcome":{"type":"string"},"notes":{"type":"string"}}},"source":"outputs","required":false},"outputs.$.headers":{"key":"outputs.$.headers","type":"object","isAdvanced":false,"name":"headers","title":"Headers","schema":{"type":"object","title":"Headers"},"source":"outputs","required":false},"outputs.$.relativePathParameters":{"key":"outputs.$.relativePathParameters","type":"object","isAdvanced":false,"name":"relativePathParameters","title":"Headers","schema":{"type":"object","title":"Headers"},"source":"outputs","required":false},"outputs.$.queries":{"key":"outputs.$.queries","type":"object","isAdvanced":false,"name":"queries","title":"Queries","schema":{"type":"object","title":"Queries"},"source":"outputs","required":false}}},"nodeDependencies":{"inputs":{},"outputs":{"outputs.$.body":{"definition":{"outputLocation":["properties","body"],"name":"schema","schema":"Value"},"dependencyType":"StaticSchema","dependentParameters":{"610C9759-04C8-45BB-AE40-15F603A620FB":{"isValid":true}}},"outputs.$.relativePathParameters":{"definition":{"outputLocation":["properties","relativePathParameters"],"name":"relativePath","schema":"UriTemplate"},"dependencyType":"StaticSchema","dependentParameters":{"29F8B729-715B-46C4-9D5D-32B82DCFFD73":{"isValid":true}}}}},"operationMetadata":{"iconUri":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","brandColor":"#009DA5","isConnectToSystemsOperation":false},"settings":{"asynchronous":{"isSupported":false,"value":false},"correlation":{"isSupported":true},"secureInputs":{"isSupported":true},"secureOutputs":{"isSupported":true},"disableAsyncPattern":{"isSupported":false,"value":false},"disableAutomaticDecompression":{"isSupported":false},"splitOn":{"isSupported":false,"value":{"enabled":false}},"retryPolicy":{"isSupported":false},"requestOptions":{"isSupported":false},"sequential":false,"suppressWorkflowHeaders":{"isSupported":false},"suppressWorkflowHeadersOnResponse":{"isSupported":true,"value":false},"concurrency":{"isSupported":true,"value":{"enabled":false}},"singleInstance":false,"timeout":{"isSupported":false},"paging":{"isSupported":false,"value":{"enabled":false}},"uploadChunk":{"isSupported":false,"value":{}},"downloadChunkSize":{"isSupported":false},"trackedProperties":{"isSupported":false},"requestSchemaValidation":{"isSupported":false,"value":false},"conditionExpressions":{"isSupported":true},"runAfter":{"isSupported":false,"value":[]},"invokerConnection":{"isSupported":false,"value":{"enabled":false}},"statelessFlow":{"isSupported":false,"value":{"enabled":false}}},"actionMetadata":{},"repetitionInfo":{"repetitionReferences":[]}},"nodeTokenData":{"tokens":[{"key":"outputs.$.body.meta.timestamp","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"timestamp","name":"body.meta.timestamp","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.meta.submissionId","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"submissionId","name":"body.meta.submissionId","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.meta","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"meta","name":"body.meta","type":"object","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"object","properties":{"timestamp":{"type":"string"},"submissionId":{"type":"string"}}}}},{"key":"outputs.$.body.basic.employeeName","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"employeeName","name":"body.basic.employeeName","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.basic.employeeNumber","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"employeeNumber","name":"body.basic.employeeNumber","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.basic.dockDoorNumber","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"dockDoorNumber","name":"body.basic.dockDoorNumber","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.basic.vehicleNumber","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"vehicleNumber","name":"body.basic.vehicleNumber","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.basic.shift","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"shift","name":"body.basic.shift","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.basic.checklistType","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"checklistType","name":"body.basic.checklistType","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.basic","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"basic","name":"body.basic","type":"object","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"object","properties":{"employeeName":{"type":"string"},"employeeNumber":{"type":"string"},"dockDoorNumber":{"type":"string"},"vehicleNumber":{"type":"string"},"shift":{"type":"string"},"checklistType":{"type":"string"}}}}},{"key":"outputs.$.body.driver.driverName","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"driverName","name":"body.driver.driverName","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.driver.carrierName","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"carrierName","name":"body.driver.carrierName","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.driver","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"driver","name":"body.driver","type":"object","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"object","properties":{"driverName":{"type":"string"},"carrierName":{"type":"string"}}}}},{"key":"outputs.$.body.outcome","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"outcome","name":"body.outcome","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body.notes","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"notes","name":"body.notes","type":"string","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"string"}}},{"key":"outputs.$.body","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"Body","name":"body","type":"object","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"object","properties":{"meta":{"type":"object","properties":{"timestamp":{"type":"string"},"submissionId":{"type":"string"}}},"basic":{"type":"object","properties":{"employeeName":{"type":"string"},"employeeNumber":{"type":"string"},"dockDoorNumber":{"type":"string"},"vehicleNumber":{"type":"string"},"shift":{"type":"string"},"checklistType":{"type":"string"}}},"driver":{"type":"object","properties":{"driverName":{"type":"string"},"carrierName":{"type":"string"}}},"outcome":{"type":"string"},"notes":{"type":"string"}}}}},{"key":"outputs.$.headers","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"Headers","name":"headers","type":"object","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"object","title":"Headers"}}},{"key":"outputs.$.relativePathParameters","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"Headers","name":"relativePathParameters","type":"object","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"object","title":"Headers"}}},{"key":"outputs.$.queries","brandColor":"#009DA5","icon":"https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/request.1cff129c.png","title":"Queries","name":"queries","type":"object","isAdvanced":false,"outputInfo":{"type":"outputs","required":false,"source":"outputs","isSecure":false,"schema":{"type":"object","title":"Queries"}}}],"upstreamNodeIds":[]},"nodeOperationInfo":{"connectorId":"Request","operationId":"Request","type":"Request","kind":"Http"},"nodeConnectionData":null,"isScopeNode":false,"mslaNode":true}",           // e.g. "https://your-endpoint.example/submit"
  method: "POST",        // "POST"
  saveAsFile: false       // Keep true to download a JSON receipt locally
};

/* =========================================================================================
   Utilities
   =======================================================================================*/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const stepper = $("#stepper");
const sections = ["sec-basic","sec-visual","sec-dcv","sec-cdv","sec-outcome","sec-success"];
function showSection(id){
  sections.forEach(s=>$("#"+s).classList.toggle("active", s===id));
  renderStepper(id);
  scrollTo({top:0,behavior:"smooth"});
}
function renderStepper(activeId){
  const names = ["Basic","Visual","Dedicated Carrier","Carrier Driver","Outcome","Done"];
  stepper.innerHTML = sections.map((s,i)=>{
    const on = s===activeId ? "step on":"step";
    return `<div class="${on}">${names[i]}</div>`;
  }).join("");
}
function required(val){ return val && String(val).trim().length>0; }
function fileToBase64(file){ return new Promise((resolve,reject)=>{
  const r = new FileReader();
  r.onload = () => resolve(r.result);
  r.onerror = reject;
  r.readAsDataURL(file);
});}

/* =========================================================================================
   Dynamic question builders
   =======================================================================================*/
const TYPES = {
  LONG:  "Long Box Trailer Dock Validation Checklist",
  HALF:  "Half Set Trailer Dock Validation Checklist",
  BOX:   "Box Truck Dock Validation Checklist"
};
function qYesNo({id,label,afterNoSkipTo,leaderPrompt=true,noteOnYes=""}){
  // Returns a DOM block for a Yes/No question with optional Leader name prompt on "No"
  const wrap = document.createElement("div");
  wrap.className = "q";
  wrap.dataset.qid = id;
  wrap.innerHTML = `
    <h4>${label}</h4>
    <div class="choices">
      <label><input type="radio" name="${id}" value="Yes"> Yes</label>
      <label><input type="radio" name="${id}" value="No"> No</label>
      ${noteOnYes ? `<span class="chip warn">${noteOnYes}</span>` : ""}
    </div>
    <div class="leader hidden">
      <div class="note"><strong>Please engage a leader</strong> to complete the previous task and resubmit form.</div>
      <label class="required" for="${id}_leader">Leader Name</label>
      <input id="${id}_leader" />
    </div>
  `;
  // Attach behavior
  const radios = wrap.querySelectorAll(`input[name="${id}"]`);
  radios.forEach(r=>{
    r.addEventListener("change", ()=>{
      const isNo = r.value==="No" && r.checked;
      const leader = wrap.querySelector(".leader");
      if(leader && leaderPrompt) leader.classList.toggle("hidden", !isNo);
      if(isNo && afterNoSkipTo){
        // Mark current section as complete and skip
        wrap.closest(".section").dataset.skipTo = afterNoSkipTo;
        // Disable remaining questions in this section
        disableFollowingQuestions(wrap);
      }else{
        // If re-selected Yes after No, re-enable subsequent questions
        wrap.closest(".section").dataset.skipTo = "";
        enableFollowingQuestions(wrap);
      }
    });
  });
  return wrap;
}
function disableFollowingQuestions(node){
  // Disable/hide all following .q siblings
  let n = node.nextElementSibling;
  while(n){
    if(n.classList.contains("q")) n.classList.add("hidden");
    n = n.nextElementSibling;
  }
}
function enableFollowingQuestions(node){
  // Re-show all .q siblings (used when user changes mind)
  let parent = node.parentElement;
  parent.querySelectorAll(".q.hidden").forEach(el=>el.classList.remove("hidden"));
}

/* =========================================================================================
   Build Visual & Validation sections based on selected type
   =======================================================================================*/
function buildVisual(type){
  const vc = $("#vc-container");
  vc.innerHTML = "";
  if(type===TYPES.LONG || type===TYPES.HALF){
    vc.append(
      qYesNo({id:"vc_docklock", label:"Is Dock Lock engaged?", afterNoSkipTo:"sec-dcv"}),
      qYesNo({id:"vc_clearance", label:"Does overhead clearance accommodate equipment, person(s), or carrier?", afterNoSkipTo:"sec-dcv"}),
      qYesNo({id:"vc_plate", label:"Is the Dock Plate secure?", afterNoSkipTo:"sec-dcv"}),
      qYesNo({id:"vc_walls", label:"Are the walls, roof, and doors of trailer in good condition (no structural damage)?", afterNoSkipTo:"sec-dcv"}),
      qYesNo({id:"vc_floor", label:"Is the floor clean and clear of cracks, holes, delamination, or excessive wear?", afterNoSkipTo:"sec-dcv"})
    );
  } else if(type===TYPES.BOX){
    vc.append(
      qYesNo({id:"bx_driverout", label:"Driver is out of the cab", afterNoSkipTo:"sec-cdv"}),
      qYesNo({id:"bx_clearance", label:"Does overhead clearance accommodate equipment, person(s), or carrier?", afterNoSkipTo:"sec-cdv"}),
      qYesNo({id:"bx_plate", label:"Dock plate secure if elevation is similar?", afterNoSkipTo:"sec-cdv"}),
      qYesNo({id:"bx_walls", label:"Are the walls, roof, and doors in good condition (no structural damage)?", afterNoSkipTo:"sec-cdv"}),
      qYesNo({id:"bx_floor", label:"Is the floor clean and clear of cracks, holes, delamination, or excessive wear?", afterNoSkipTo:"sec-cdv"}),
      // Special: Fall risk – either selection moves to next section; Yes shows a note
      qYesNo({id:"bx_fallrisk", label:"Fall risk of 4 feet or greater.", afterNoSkipTo:"sec-cdv", leaderPrompt:false, noteOnYes:"If YES, box truck must be moved to yard or ramp."})
    );
    // Force skip to next section after any selection on fall risk
    vc.querySelectorAll('input[name="bx_fallrisk"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        $("#sec-visual").dataset.skipTo = "sec-cdv";
      });
    });
  }
}
function buildDCV(type){
  const dcv = $("#dcv-container");
  dcv.innerHTML = "";
  if(type===TYPES.LONG || type===TYPES.HALF){
    dcv.append(
      qYesNo({id:"dcv_landing", label:"Landing Gear, crossbars, ICC Bar. No damage, deformation, or missing pieces.", afterNoSkipTo:"sec-outcome"}),
      qYesNo({id:"dcv_exterior", label:"Exterior walls, roof, & doors. No damage that affects structural integrity.", afterNoSkipTo:"sec-outcome"})
    );
    if(type===TYPES.HALF){
      dcv.append(
        qYesNo({id:"dcv_jack", label:"Jack Stand positioned snugly at the center of the front of the trailer.", afterNoSkipTo:"sec-outcome"})
      );
    }
  }
}
function buildCDV(){
  const cdv = $("#cdv-container");
  cdv.innerHTML = "";
  cdv.append(
    qYesNo({id:"cdv_engine", label:"Engine is shut off", afterNoSkipTo:"sec-outcome"}),
    qYesNo({id:"cdv_brake", label:"Emergency brake is applied", afterNoSkipTo:"sec-outcome"}),
    qYesNo({id:"cdv_chocks", label:"Wheel chocks applied by the driver", afterNoSkipTo:"sec-outcome"})
  );
}

/* =========================================================================================
   Signature pad
   =======================================================================================*/
let sigPad, sigCanvas;
function initSignature(){
  sigCanvas = document.getElementById("sigPad");
  // Resize for device pixel ratio
  function resize(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    sigCanvas.width  = sigCanvas.offsetWidth * ratio;
    sigCanvas.height = sigCanvas.offsetHeight * ratio;
    sigPad && sigPad.clear();
  }
  window.addEventListener("resize", resize);
  resize();
  sigPad = new SignaturePad(sigCanvas, {backgroundColor:"#fff"});
  $("#sigClear").addEventListener("click", ()=>sigPad.clear());
}

/* =========================================================================================
   Navigation + validation
   =======================================================================================*/
function goNextFrom(sectionId){
  const sec = $("#"+sectionId);
  const skipTo = sec.dataset.skipTo;
  if(skipTo){ showSection(skipTo); return; }
  // default linear flow
  if(sectionId==="sec-basic")      showSection("sec-visual");
  else if(sectionId==="sec-visual"){
    const type = $("#checklistType").value;
    if(type===TYPES.BOX) showSection("sec-cdv"); else showSection("sec-dcv");
  }
  else if(sectionId==="sec-dcv" || sectionId==="sec-cdv") showSection("sec-outcome");
}
function goBackFrom(sectionId){
  if(sectionId==="sec-visual") showSection("sec-basic");
  if(sectionId==="sec-dcv")    showSection("sec-visual");
  if(sectionId==="sec-cdv")    showSection("sec-visual");
  if(sectionId==="sec-outcome"){
    const type = $("#checklistType").value;
    showSection(type===TYPES.BOX ? "sec-cdv" : "sec-dcv");
  }
}

/* =========================================================================================
   Collect + Submit
   =======================================================================================*/
async function collectData(){
  const type = $("#checklistType").value;
  const outcome = $$('input[name="outcome"]').find(r=>r.checked)?.value || "";
  const photoFile = $("#photo").files[0];
  const photoB64 = photoFile ? await fileToBase64(photoFile) : "";
  const sigB64 = !sigPad.isEmpty() ? sigPad.toDataURL() : "";

  const readYN = name => ($$('input[name="'+name+'"]').find(x=>x.checked)?.value)||"";
  const leader = id => ($("#"+id+"_leader")?.value)||"";

  const payload = {
    meta:{
      timestamp: new Date().toISOString(),
      submissionId: crypto.randomUUID()
    },
    basic:{
      employeeName: $("#empName").value,
      employeeNumber: $("#empNo").value,
      dockDoorNumber: $("#dockDoor").value,
      vehicleNumber: $("#vehicleNo").value,
      shift: $$('input[name="shift"]').find(r=>r.checked)?.value || "",
      checklistType: type
    },
    visual:{},
    validation:{},
    driver:{
      driverName: $("#driverName").value,
      carrierName: $("#carrierName").value || ""
    },
    outcome,
    notes: $("#notes").value || "",
    signatureImage: sigB64,   // PNG data URL
    photoImage: photoB64      // Image data URL (if selected)
  };

  if(type===TYPES.LONG || type===TYPES.HALF){
    payload.visual = {
      dockLock: readYN("vc_docklock"),
      dockLock_leader: leader("vc_docklock"),
      clearance: readYN("vc_clearance"),
      clearance_leader: leader("vc_clearance"),
      plate: readYN("vc_plate"),
      plate_leader: leader("vc_plate"),
      walls: readYN("vc_walls"),
      walls_leader: leader("vc_walls"),
      floor: readYN("vc_floor"),
      floor_leader: leader("vc_floor")
    };
    payload.validation = {
      landingGear: readYN("dcv_landing"),
      landingGear_leader: leader("dcv_landing"),
      exterior: readYN("dcv_exterior"),
      exterior_leader: leader("dcv_exterior"),
      jackStand: type===TYPES.HALF ? readYN("dcv_jack") : "",
      jackStand_leader: type===TYPES.HALF ? leader("dcv_jack") : ""
    };
  } else { // BOX
    payload.visual = {
      driverOut: readYN("bx_driverout"),
      driverOut_leader: leader("bx_driverout"),
      clearance: readYN("bx_clearance"),
      clearance_leader: leader("bx_clearance"),
      plate: readYN("bx_plate"),
      plate_leader: leader("bx_plate"),
      walls: readYN("bx_walls"),
      walls_leader: leader("bx_walls"),
      floor: readYN("bx_floor"),
      floor_leader: leader("bx_floor"),
      fallRisk4ft: readYN("bx_fallrisk")
    };
    payload.validation = {
      engineOff: readYN("cdv_engine"),
      engineOff_leader: leader("cdv_engine"),
      emergencyBrake: readYN("cdv_brake"),
      emergencyBrake_leader: leader("cdv_brake"),
      wheelChocks: readYN("cdv_chocks"),
      wheelChocks_leader: leader("cdv_chocks")
    };
  }
  return payload;
}
function downloadJSON(data, fileName){
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* =========================================================================================
   Wire up UI
   =======================================================================================*/
window.addEventListener("DOMContentLoaded", ()=>{
  renderStepper("sec-basic");
  initSignature();

  // Start Visual Check
  $("#toVisual").addEventListener("click", ()=>{
    // Basic validations
    if(!required($("#empName").value) || !required($("#empNo").value) ||
       !required($("#dockDoor").value) || !required($("#vehicleNo").value) ||
       !required($("#checklistType").value) || !$$('input[name="shift"]').some(r=>r.checked)){
      alert("Please complete all required basic fields.");
      return;
    }
    const type = $("#checklistType").value;
    buildVisual(type);
    buildDCV(type);
    buildCDV();
    // Adjust driver labels for Box vs Trailer
    const isBox = type===TYPES.BOX;
    $("#driverLabel").textContent = isBox ? "Carrier / Driver Name" : "JB Hunt / Ryder Driver Name";
    $("#carrierNameWrap").classList.toggle("hidden", !isBox);
    showSection("sec-visual");
  });

  // Visual nav
  $("#vc-prev").addEventListener("click", ()=>goBackFrom("sec-visual"));
  $("#vc-next").addEventListener("click", ()=>goNextFrom("sec-visual"));

  // DCV nav
  $("#dcv-prev").addEventListener("click", ()=>goBackFrom("sec-dcv"));
  $("#dcv-next").addEventListener("click", ()=>goNextFrom("sec-dcv"));

  // CDV nav
  $("#cdv-prev").addEventListener("click", ()=>goBackFrom("sec-cdv"));
  $("#cdv-next").addEventListener("click", ()=>goNextFrom("sec-cdv"));

  // Outcome behavior
  $$('input[name="outcome"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      $("#failMsg").classList.toggle("hidden", r.value!=="Fail (X)");
    });
  });
  $("#outcome-prev").addEventListener("click", ()=>goBackFrom("sec-outcome"));

  // Submit
  $("#submitBtn").addEventListener("click", async ()=>{
    // Minimal validation
    const type = $("#checklistType").value;
    const needCarrier = (type===TYPES.BOX);
    const outcome = $$('input[name="outcome"]').some(r=>r.checked);
    if(!required($("#driverName").value) || (needCarrier && !required($("#carrierName").value)) || !outcome){
      alert("Please complete Driver/Carrier and Outcome.");
      return;
    }
    const payload = await collectData();

    // Save locally as JSON
    if(CONFIG.saveAsFile){
      const fileName = `dock_validation_${payload.meta.submissionId}.json`;
      downloadJSON(payload, fileName);
    }
    // Optional POST to backend
    if(CONFIG.postUrl){
      try{
        const res = await fetch(CONFIG.postUrl, {
          method: CONFIG.method,
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error("Server returned "+res.status);
      }catch(err){
        alert("Warning: failed to POST to server. Local JSON was still downloaded.\n"+err.message);
      }
    }
    showSection("sec-success");
  });

  // Submit another
  $("#submitAnother").addEventListener("click", ()=>{
    // Reset simple inputs
    $$("input, textarea, select").forEach(e=>{
      if(e.type==="radio" || e.type==="checkbox") e.checked=false;
      else if(e.type==="file") e.value="";
      else e.value="";
    });
    sigPad.clear();
    // Reset dynamic sections
    $("#vc-container").innerHTML="";
    $("#dcv-container").innerHTML="";
    $("#cdv-container").innerHTML="";
    sections.forEach(id=>$("#"+id).dataset.skipTo="");
    showSection("sec-basic");
  });
});
</script>
</body>
</html>
